<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <link href="css/style.css" rel="stylesheet"></link>
    <script type="text/javascript">
        'use strict';

        let time_to_first_input = function() {

        const perf = window.performance;

        if(perf && perf.getEntriesByType) {
            
            const current_time = Math.floor(perf.now());
            console.log(`User first input since page navigation start: ${current_time}`);

            
            let fcp_time = Math.floor(perf.getEntriesByName('first-contentful-paint')[0].startTime);
            console.log(`First contentful paint duration since page navigation start: ${fcp_time}`);
            console.log(`User first input since first contentful piant: ${current_time - fcp_time}`);


            let user_marks = perf.getEntriesByType('mark');
            if (user_marks.length > 0) {
            let last_user_mark_time = Math.floor(user_marks[user_marks.length - 1].startTime);
            console.log(`Performance mark duration since page navigation start: ${last_user_mark_time}`);
            console.log(`User first input since lastest performance mark: ${current_time - last_user_mark_time}`);
            }
            
            setTimeout(() => {
            let fid_time = perf.getEntriesByType('first-input');
            if(fid_time.length > 0) { // scoll is not included in 'first-input' event
                let fid_start_time = Math.floor(fid_time[0].startTime);
                let fid_process_start = Math.floor(fid_time[0].processingStart);
                let fid_process_end = Math.floor(fid_time[0].processingEnd);
                console.log(`First input event since page navigation start: ${fid_start_time}`);
                console.log(`First input delay: ${fid_process_start-fid_start_time}`);
                console.log(`First input processing time: ${fid_process_end-fid_process_start}`);
                console.log(`First ux input delay: ${current_time-fid_process_start}`);
            }
            }, 1000);
            
        } else {
            console.log("performance object is not supported by current browser, remove the event listener anyway...");
        }
        //remove the eventlistener once user either conduct 'click' or 'scroll' on the page
        window.removeEventListener('scroll', time_to_first_input);
        window.removeEventListener('click', time_to_first_input);
        window.removeEventListener('keydown', time_to_first_input);

        // To-DO: will use the fetch API to bring those data back to logging server

        };

        window.addEventListener('scroll', time_to_first_input);
        window.addEventListener('click', time_to_first_input);
        window.addEventListener('keydown', time_to_first_input);
    </script>
</head>

<body>
    <input id="pointless-computations" type="button" name="pointless-computations" value="Long running js simulation" />

    <input id="start-stop" type="button" name="start-stop" value="Fast running js simulation" />
    
    <input type="text" class="input-text" placeholder="try to feed me some text" autofocus>

    <div id="container">
        <div class="moving-box"></div>
    </div>

    <script type="text/javascript" src="js/blocking.js"></script>
    <script type="text/javascript" src="js/main.js"></script>
    <script type="text/javascript" src="js/calculate.js"></script>
    <script type="text/javascript">
        performance.mark('mark-majorScriptsLoaded');
    </script>
</body>

</html>
